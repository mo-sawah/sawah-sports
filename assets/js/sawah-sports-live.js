/**
 * Sawah Sports Premium - Frontend JavaScript
 * v1.0.0 - Bug fixes and enhancements
 */

(function(){"use strict";const API={get:async(path,params={})=>{const url=new URL(SawahSports.restUrl+path,window.location.origin);Object.keys(params).forEach(k=>{if(params[k]!==undefined&&params[k]!==null&&params[k]!==''){url.searchParams.set(k,params[k])}});try{const res=await fetch(url.toString(),{headers:{'X-WP-Nonce':SawahSports.nonce}});let data=null;try{data=await res.json()}catch(e){}if(!res.ok){const msg=data?.message||data?.data?.message||'HTTP '+res.status;throw new Error(msg)}return data}catch(error){console.error('[Sawah Sports]',error);throw error}}};const DOM={el:(tag,attrs={},children=[])=>{const n=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>{if(k==='class')n.className=v;else if(k==='text')n.textContent=v;else if(k==='html')n.innerHTML=v;else n.setAttribute(k,v)});children.forEach(c=>n.appendChild(c));return n},unwrap:(x)=>{if(!x)return x;if(Array.isArray(x))return x;if(typeof x==='object'&&x.data!==undefined)return x.data;return x},clear:(el)=>{while(el.firstChild)el.removeChild(el.firstChild)},showError:(container,message)=>{DOM.clear(container);container.appendChild(DOM.el('div',{class:'ss-error',text:message}))},showEmpty:(container,message)=>{DOM.clear(container);container.appendChild(DOM.el('div',{class:'ss-empty',text:message}))}};const Team={fromParticipants:(participants,location)=>{const list=DOM.unwrap(participants);if(!Array.isArray(list))return null;const byMeta=list.find(x=>x?.meta?.location?.toLowerCase()===location);if(byMeta)return byMeta;return list[location==='home'?0:1]||null},logo:(team)=>team?.image_path||team?.logo_path||'',initials:(name)=>{const words=String(name||'').trim().split(/\s+/).filter(Boolean);if(!words.length)return '—';const a=words[0][0]||'';const b=words.length>1?words[words.length-1][0]:'';return(a+b).toUpperCase()},node:(team,align='left')=>{const name=team?.name||team?.short_code||'—';const logo=Team.logo(team);const badge=logo?DOM.el('img',{class:'ss-team-logo',src:logo,alt:name,loading:'lazy'}):DOM.el('span',{class:'ss-team-logo ss-team-fallback',text:Team.initials(name)});return DOM.el('div',{class:`ss-team is-${align}`},[badge,DOM.el('span',{class:'ss-team-name',text:name})])}};const Match={score:(fx)=>{const scores=DOM.unwrap(fx?.scores);if(!Array.isArray(scores))return '— : —';const current=scores.find(s=>s?.description?.toLowerCase().includes('current'))||scores[scores.length-1];if(current?.score){const h=current.score.home??current.score.home_score??'—';const a=current.score.away??current.score.away_score??'—';return`${h} : ${a}`}return '— : —'},state:(fx)=>{const st=DOM.unwrap(fx?.state);return st?.short_name||st?.short||st?.name||''},kickoff:(fx)=>{const s=fx?.starting_at;if(!s)return'';const m=String(s).match(/(\d{2}):(\d{2})/);return m?`${m[1]}:${m[2]}`:''},isLive:(fx)=>{const state=Match.state(fx).toUpperCase();return['LIVE','HT','ET','PEN_LIVE','AET'].includes(state)}};const Widgets={liveMatches:{render:(root,data)=>{const body=root.querySelector('.ss-body');const fixtures=data?.data||[];if(!fixtures.length){DOM.showEmpty(body,SawahSports.i18n.noLive||'No live matches');return}const list=DOM.el('div',{class:'ss-match-list'});fixtures.forEach(fx=>{const participants=fx?.participants||[];const home=Team.fromParticipants(participants,'home');const away=Team.fromParticipants(participants,'away');const league=DOM.unwrap(fx.league);const row=DOM.el('div',{class:'ss-match-row'},[DOM.el('div',{class:'ss-match-head'},[DOM.el('div',{class:'ss-league',text:league?.name||''}),DOM.el('div',{class:'ss-badges'},[DOM.el('span',{class:'ss-badge ss-badge-live'},[DOM.el('span',{class:'ss-pulse'}),document.createTextNode(SawahSports.i18n.live||'LIVE')]),DOM.el('span',{class:'ss-pill',text:Match.state(fx)})])]),DOM.el('div',{class:'ss-match-mid'},[Team.node(home,'left'),DOM.el('div',{class:'ss-scorebox'},[DOM.el('div',{class:'ss-score is-live',text:Match.score(fx)}),DOM.el('div',{class:'ss-kickoff',text:Match.kickoff(fx)})]),Team.node(away,'right')])]);list.appendChild(row)});DOM.clear(body);body.appendChild(list)},load:async(root)=>{try{const data=await API.get('/livescores');Widgets.liveMatches.render(root,data)}catch(error){DOM.showError(root.querySelector('.ss-body'),SawahSports.i18n.liveErr||'Unable to load')}}},fixtures:{render:(root,data)=>{const body=root.querySelector('.ss-body');const fixtures=data?.data||[];if(!fixtures.length){DOM.showEmpty(body,SawahSports.i18n.noFixtures||'No fixtures');return}const list=DOM.el('div',{class:'ss-match-list'});fixtures.forEach(fx=>{const participants=fx?.participants||[];const home=Team.fromParticipants(participants,'home');const away=Team.fromParticipants(participants,'away');const league=DOM.unwrap(fx.league);const isLive=Match.isLive(fx);const row=DOM.el('div',{class:'ss-match-row'},[DOM.el('div',{class:'ss-match-head'},[DOM.el('div',{class:'ss-league',text:league?.name||''}),DOM.el('div',{class:'ss-badges'},[isLive?DOM.el('span',{class:'ss-badge ss-badge-live'},[DOM.el('span',{class:'ss-pulse'}),document.createTextNode('LIVE')]):null,DOM.el('span',{class:'ss-pill',text:Match.state(fx)})].filter(Boolean))]),DOM.el('div',{class:'ss-match-mid'},[Team.node(home,'left'),DOM.el('div',{class:'ss-scorebox'},[DOM.el('div',{class:`ss-score${isLive?' is-live':''}`,text:Match.score(fx)}),DOM.el('div',{class:'ss-kickoff',text:Match.kickoff(fx)})]),Team.node(away,'right')])]);list.appendChild(row)});DOM.clear(body);body.appendChild(list)},load:async(root)=>{const date=root.getAttribute('data-date')||'';try{const data=await API.get('/fixtures',{date});Widgets.fixtures.render(root,data)}catch(error){DOM.showError(root.querySelector('.ss-body'),SawahSports.i18n.fixturesErr||'Unable to load')}}},standings:{render:(root,data)=>{const body=root.querySelector('.ss-body');const rows=data?.data||[];const showForm=root.getAttribute('data-show-form')==='1';if(!rows.length){DOM.showEmpty(body,SawahSports.i18n.noStandings||'No standings');return}const table=DOM.el('table',{class:'ss-standings-table'});const thead=DOM.el('thead',{},[DOM.el('tr',{},[DOM.el('th',{text:'#'}),DOM.el('th',{text:'Team'}),DOM.el('th',{text:'P'}),DOM.el('th',{text:'W'}),DOM.el('th',{text:'D'}),DOM.el('th',{text:'L'}),DOM.el('th',{text:'GF'}),DOM.el('th',{text:'GA'}),DOM.el('th',{text:'GD'}),DOM.el('th',{text:'Pts'}),showForm?DOM.el('th',{text:'Form'}):null].filter(Boolean))]);table.appendChild(thead);const tbody=DOM.el('tbody');rows.forEach(r=>{const team=DOM.unwrap(r.participant||r.team);const name=team?.name||'';const logo=Team.logo(team);const teamCell=DOM.el('div',{class:'ss-td-team'});if(logo){teamCell.appendChild(DOM.el('img',{class:'ss-team-logo',src:logo,alt:name,loading:'lazy'}))}else{teamCell.appendChild(DOM.el('span',{class:'ss-team-logo ss-team-fallback',text:Team.initials(name)}))}teamCell.appendChild(DOM.el('span',{class:'ss-team-name',text:name}));const formNode=showForm?Widgets.standings.renderForm(r.form):null;const tr=DOM.el('tr',{},[DOM.el('td',{class:'ss-td-pos',text:r.position||'—'}),DOM.el('td',{},[teamCell]),DOM.el('td',{text:r.played||'—'}),DOM.el('td',{text:r.won||'—'}),DOM.el('td',{text:r.draw||'—'}),DOM.el('td',{text:r.lost||'—'}),DOM.el('td',{text:r.goals_for||'—'}),DOM.el('td',{text:r.goals_against||'—'}),DOM.el('td',{text:r.goal_difference||'—'}),DOM.el('td',{class:'ss-td-pts',text:r.points||'—'}),showForm?DOM.el('td',{},[formNode]):null].filter(Boolean));tbody.appendChild(tr)});table.appendChild(tbody);DOM.clear(body);body.appendChild(DOM.el('div',{class:'ss-table-wrap'},[table]))},renderForm:(form)=>{const str=form?.form||form||'';if(!str)return DOM.el('span',{class:'ss-muted',text:'—'});const wrap=DOM.el('div',{class:'ss-form'});String(str).slice(-5).split('').forEach(ch=>{const c=ch.toUpperCase();const cls=c==='W'?'is-w':c==='D'?'is-d':c==='L'?'is-l':'is-n';wrap.appendChild(DOM.el('span',{class:`ss-form-dot ${cls}`,text:c}))});return wrap},load:async(root)=>{const seasonId=root.getAttribute('data-season');if(!seasonId){DOM.showError(root.querySelector('.ss-body'),'Season ID required');return}try{const data=await API.get(`/standings/${seasonId}`);Widgets.standings.render(root,data)}catch(error){DOM.showError(root.querySelector('.ss-body'),SawahSports.i18n.standingsErr||'Unable to load')}}}};function init(){document.querySelectorAll('.ss-widget.ss-live').forEach(root=>{Widgets.liveMatches.load(root);const refresh=parseInt(root.getAttribute('data-refresh')||'0',10);if(refresh>0){setInterval(()=>Widgets.liveMatches.load(root),refresh*1000)}});document.querySelectorAll('.ss-widget.ss-fixtures').forEach(root=>{Widgets.fixtures.load(root)});document.querySelectorAll('.ss-widget.ss-standings').forEach(root=>{Widgets.standings.load(root)})}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init)}else{init()}})();
